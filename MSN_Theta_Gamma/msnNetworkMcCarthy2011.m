% Model: test
cd /Users/benjaminpittman-polletta/Documents/Science/Research_Projects/dnsim/test;
spec=[];
spec.nodes(1).label = 'MSN';
spec.nodes(1).multiplicity = 100;
spec.nodes(1).dynamics = {'V''=current'};
spec.nodes(1).mechanisms = {'MSN_kCurrentMSN','MSN_naCurrentMSN','MSN_injectedCurrentMSN','MSN_leakCurrentMSN','MSN_mCurrentMSN','MSN_noisyInputMSN'};
spec.nodes(1).parameters = [];
spec.connections(1,1).label = 'MSN-MSN';
spec.connections(1,1).mechanisms = {'MSN_MSN_gabaRecInputMSN'};
spec.connections(1,1).parameters = [];
%dnsim(spec); % open model in DNSim GUI

% DNSim simulation and plots:
data = runsim(spec,'timelimits',[0 100],'dt',.02,'SOLVER','euler'); % simulate DNSim models
plotv(data,spec,'varlabel','V'); % quickly plot select variables
%visualizer(data); % ugly interactive tool hijacked to visualize sim_data

% Sweep over parameter values:
model=buildmodel(spec); % parse DNSim spec structure
simstudy(model,{'MSN'},{'N'},{'[1 2]'},'timelimits',[0 100],'dt',.02,'SOLVER','euler'); % N = # of cells


% Manual simulation and plots:
%{
%-----------------------------------------------------------
% Auxiliary variables:
	MSN_mCurrentMSN_Qs   = (2.3)^(.1*(37-23));
	MSN_MSN_gabaRecInputMSN_Nmax = max((100),(100));
	MSN_MSN_gabaRecInputMSN_srcpos = linspace(1,MSN_MSN_gabaRecInputMSN_Nmax,(100))'*ones(1,(100));
	MSN_MSN_gabaRecInputMSN_dstpos = (linspace(1,MSN_MSN_gabaRecInputMSN_Nmax,(100))'*ones(1,(100)))';
	MSN_MSN_gabaRecInputMSN_netcon = eye((100),(100));

% Anonymous functions:
	MSN_kCurrentMSN_alpha_m = @(MSN_V) 0.032*(MSN_V+52)./(1-exp(-(MSN_V+52)/5));
	MSN_kCurrentMSN_beta_m = @(MSN_V) 0.5*exp(-(MSN_V+57)/40);       
	MSN_kCurrentMSN_i_k  = @(MSN_V,MSN_kCurrentMSN_m) (80)*MSN_kCurrentMSN_m.^4.*(MSN_V-(-100));
	MSN_naCurrentMSN_alpha_m = @(MSN_V) 0.32*(MSN_V+54)./(1-exp(-(MSN_V+54)/4));
	MSN_naCurrentMSN_beta_m = @(MSN_V) 0.28*(MSN_V+27)./(exp((MSN_V+27)/5)-1);
	MSN_naCurrentMSN_alpha_h = @(MSN_V) 0.128*exp(-(MSN_V+50)/18);     
	MSN_naCurrentMSN_beta_h = @(MSN_V) 4./(1+exp(-(MSN_V+27)/5));     
	MSN_naCurrentMSN_i_na = @(MSN_V,MSN_naCurrentMSN_m,MSN_naCurrentMSN_h) (100)*MSN_naCurrentMSN_m.^3.*MSN_naCurrentMSN_h.*(MSN_V-(50));
	MSN_leakCurrentMSN_i_l = @(X) (0.1)*(X-(-67));                   
	MSN_mCurrentMSN_alpha_m = @(MSN_V) MSN_mCurrentMSN_Qs*1e-4*(MSN_V-(-30))./(1-exp(-(MSN_V-(-30))/9));
	MSN_mCurrentMSN_beta_m = @(MSN_V) -MSN_mCurrentMSN_Qs*1e-4*(MSN_V-(-30))./(1-exp((MSN_V-(-30))/9));
	MSN_mCurrentMSN_i_m  = @(MSN_V,MSN_mCurrentMSN_m) (1.2)*MSN_mCurrentMSN_m.*(MSN_V-(-100));
	MSN_noisyInputMSN_i_noise = @(t) (4).*randn((100),1).*sqrt((0.01)); 
	MSN_MSN_gabaRecInputMSN_i_gaba = @(MSN_V,MSN_MSN_gabaRecInputMSN_s) ((0.1)/((100)-1)).*(MSN_MSN_gabaRecInputMSN_netcon*MSN_MSN_gabaRecInputMSN_s).*(MSN_V-(-80));

% ODE Handle, ICs, integration, and plotting:
ODEFUN = @(t,X) [((-((80)*X(101:200).^4.*(X(1:100)-(-100))))+((-((100)*X(201:300).^3.*X(301:400).*(X(1:100)-(50))))+(((1.19))+((-((0.1)*(X(1:100)-(-67))))+((-((1.2)*X(401:500).*(X(1:100)-(-100))))+((((4).*randn((100),1).*sqrt((0.01))))+((-(((0.1)/((100)-1)).*(MSN_MSN_gabaRecInputMSN_netcon*X(501:600)).*(X(1:100)-(-80))))+0)))))));(0.032*(X(1:100)+52)./(1-exp(-(X(1:100)+52)/5))).*(1-X(101:200))-(0.5*exp(-(X(1:100)+57)/40)).*X(101:200);(0.32*(X(1:100)+54)./(1-exp(-(X(1:100)+54)/4))).*(1-X(201:300))-(0.28*(X(1:100)+27)./(exp((X(1:100)+27)/5)-1)).*X(201:300);(0.128*exp(-(X(1:100)+50)/18)).*(1-X(301:400))-(4./(1+exp(-(X(1:100)+27)/5))).*X(301:400);(MSN_mCurrentMSN_Qs*1e-4*(X(1:100)-(-30))./(1-exp(-(X(1:100)-(-30))/9))).*(1-X(401:500)) - (-MSN_mCurrentMSN_Qs*1e-4*(X(1:100)-(-30))./(1-exp((X(1:100)-(-30))/9))).*X(401:500);-X(501:600)./(13) + 2*(1+tanh(X(1:100)/4)).*(1-X(501:600));];
IC = [0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0           0    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.070205    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542    0.032542      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888      0.9888    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924    0.024924      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001      0.0001];

[t,y]=ode23(ODEFUN,[0 100],IC);   % numerical integration
figure; plot(t,y);           % plot all variables/functions
try legend('MSN\_V','MSN\_kCurrentMSN\_m','MSN\_naCurrentMSN\_m','MSN\_naCurrentMSN\_h','MSN\_mCurrentMSN\_m','MSN\_MSN\_gabaRecInputMSN\_s'); end
%-
%}
